---
title: "GS Lab Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
css: css/styles.css
---

Home
=====================================

```{r home_counter, echo=FALSE, results='asis'}
library(tidyverse)
library(plotly)
library(openxlsx)

htmltools::browsable(
  htmltools::tagList(
    # Hero + counters (generated as real HTML)
    htmltools::tags$div(class = "home-hero",
      htmltools::tags$h1("游녦 Welcome to the GS Team Dashboard"),
      htmltools::tags$div(class = "counter-grid",
        htmltools::tags$div(class = "counter-box",
          htmltools::tags$div(class = "counter-label", "游 Bacteria Cases"),
          htmltools::tags$div(class = "counter", `data-target` = "1000", "0")
        ),
        htmltools::tags$div(class = "counter-box",
          htmltools::tags$div(class = "counter-label", "游꼓 Fungi Cases"),
          htmltools::tags$div(class = "counter", `data-target` = "1000", "0")
        ),
        htmltools::tags$div(class = "counter-box",
          htmltools::tags$div(class = "counter-label", "游눌 Virus Cases"),
          htmltools::tags$div(class = "counter", `data-target` = "1000", "0")
        )
      )
    ),

    # Inline JS injected via htmltools (not escaped, reliably executed)
    htmltools::tags$script(
      htmltools::HTML("
      document.addEventListener('DOMContentLoaded', function() {
        var counters = document.querySelectorAll('.counter');
        counters.forEach(function(counter) {
          var target = Number(counter.getAttribute('data-target'));
          var count = 0;
          var step = Math.max(1, Math.ceil(target / 120)); // ~2s animation
          function update() {
            count += step;
            if (count >= target) {
              counter.textContent = target.toLocaleString();
            } else {
              counter.textContent = count.toLocaleString();
              requestAnimationFrame(update);
            }
          }
          update();
        });
      });
      ")
    )
  )
)
```

---

Food-borne {data-navmenu="游Bacteria"} 
===================================== 

### E. coli 

Content for E. coli (plots, notes, links). 

---

### Listeria 

Content for Listeria. 

--- 

Clinical {data-navmenu="游Bacteria"} 
===================================== 

### Overview 

Content for H. influenzae. 

---

Fungi {data-navmenu="游꼓Fungi"} 
===================================== 

### Overview 

Content for fungal pathogens. 

--- 

Seasonal influenza {data-navmenu="游눌Viruses"} 
===================================== 

<div class="section-header influenza-header"> 
  <h2> &nbsp; Seasonal Influenza</h2> 
</div>

```{r CHP_flu_stat, cache=T}
CHP_flu_stat <- read.xlsx("data/CHP_detection_statistics_24Nov2025.xlsx", sheet = "Influenza") %>% 
  as_tibble() %>% 
  pivot_longer(-c(1:4), names_to = c("Subtype", ".value"), names_pattern = "(.*)_(.*)") %>% 
  mutate(Influenza = ifelse(grepl("^H", Subtype), "A", sub("Flu", "", Subtype)),
         Date = as.Date(paste0(sub(".*- ", "", Date), "/", Year), "%d/%m/%Y"))

dbreaks <- seq(as.Date("2019-01-01"), as.Date("2025-12-31"), by = "1 month")
target_months <- c("01", "05", "09", "12")
dbreaks2 <- dbreaks[format(dbreaks, "%m") %in% target_months]

(ggplot(CHP_flu_stat %>% filter(!Subtype %in% c("H5", "H7", "H9", "FluC")), 
       aes(Date, number, fill = Subtype)) +
  geom_col(position = "stack") +
  facet_grid(~ Year, scale = "free", switch = "x") +
  scale_fill_manual(values = c("#D62728", "#1F77B4", "#2CA02C")) +
  scale_x_date(date_breaks = "3 months", 
               date_labels = "%b",
               expand = c(0.01, -2)) +
  ylab("Count") +
  ggtitle("CHP Influenza trend in Hong Kong") +
  theme(strip.placement = "outside",
        panel.spacing = unit(0.1, "lines"))) %>% 
  ggplotly() %>% 
  layout(plot_bgcolor = "transparent", paper_bgcolor = "#f4f6f9", legend = list(bgcolor = "#f4f6f9", bordercolor = "transparent"))
```

::: flu-grid
<div class="flu-card">
  <h3>H1N1</h3>
  <p>Explore the H1N1 seasonal lineages in Hong Kong.</p>
  <a href="https://nextstrain.org/groups/HTI-Micro-Lab/h1n1pdm/ha" 
     target="_blank" class="button virus-link">View Nextstrain</a>
</div>

<div class="flu-card">
  <h3>H3N2</h3>
  <p>Explore the H3N2 seasonal lineages in Hong Kong.</p>
  <a href="https://nextstrain.org/groups/HTI-Micro-Lab/h3n2/ha" 
     target="_blank" class="button virus-link">View Nextstrain</a>
</div>
:::

Avian influenza {data-navmenu="游눌Viruses"} 
===================================== 

#### Avian flu 

Content for avian influenza. 

--- 

SARS-CoV-2 {data-navmenu="游눌Viruses"} 
===================================== 

### SARS-CoV-2 

Content for SARS-CoV-2 (plots, links, etc.)
